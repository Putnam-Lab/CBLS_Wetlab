---
title: "Daily_measurements"
author: "LaurenZane"
date: "7/19/2022"
output:
  pdf_document: default
  html_document: default
---

This script plots daily measurements from the CBLS Wet lab for the Putnam lab. Run this script daily after daily measurements are taken and inputted into the datasheet. 

Script updated 10/25/23 by JA. 

## Load packages 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate) # used for converting 8 digit date into datetime format for R
library(RColorBrewer)
library(rmarkdown)
library(tinytex)

## If seacarb needs to be downloaded:
#packageurl <- "https://cran.r-project.org/src/contrib/Archive/seacarb/seacarb_3.2.tar.gz"
#install.packages(packageurl, repos = NULL, type = "source")
#install.packages("seacarb")
library(seacarb) 
```

## Load data 
```{r}
daily <- read.csv("../Data/Daily_measurements_tracking.csv")
head(daily)
tail(daily) # check to make sure data from today is there
```

Set dates as characters 
```{r}
daily$Date <- as.character(daily$Date)
daily$tris.date <- as.character(daily$tris.date)
```


Remove quarantine_tank from the dataframe (this line can always be commented out if interested in QT values)

```{r}
daily <- daily %>%
  filter(!Tank_ID == "quarantine_tank")
```

## Calculate total pH  

Calculate the calibration curve from the Tris calibration and calculate pH on the total scale from pH.mV. 
```{r}
pHcalib<-read_csv("../Data/Tris_Calibration.csv")
pHcalib$tris.date<-as.character(pHcalib$tris.date)

pHSlope<-pHcalib %>%
  nest_by(tris.date)%>%
  mutate(fitpH = list(lm(mVTris~TTris, data = pHcalib)))

# calculating the fitpH as the same for all dates...

%>% # linear regression of mV and temp of the tris
  reframe(broom::tidy(fitpH)) %>% # make the output tidy
  dplyr::select(tris.date, term, estimate) 


%>%
  pivot_wider(names_from = term, values_from = estimate) %>%# put slope and intercept in their own column
  left_join(daily, ., by="tris.date") %>% # join with the pH sample data
  mutate(mVTris = Temperature_C*TTris + `(Intercept)`) %>%# calculate the mV of the tris at temperature in which the pH of the tanks were measured
  mutate(pH.total = seacarb::pH(Ex=pH_mv, Etris=mVTris, S=Salinity_psu, T=Temperature_C)) # calculate pH of the tanks using the pH seacarb function
```

^^^ JA working on pH code as of 10/25/23

Convert date to ymd for plotting 
```{r}
daily$Date <- ymd(daily$Date) # convert 8 digit date into datetime format
```



## Change to long format

Change data format to long format 
```{r}
daily.long <-daily %>% pivot_longer(cols=Temperature_C:Salinity_psu,
  names_to = "metric",
  values_to = "value")
```

Convert date to ymd for plotting 
```{r}
daily.long$Date <- ymd(daily.long$Date) # convert 8 digit date into datetime format
```

Filter by relevant dates if needed

## Plot

First, plot all dates 
```{r}
daily_tank<-daily.long %>%
  ggplot(aes(x=Date, y=value, colour=Tank_ID))+
  geom_point(size=2)+
  xlab("Date")+
  facet_grid(metric ~ ., scales = "free")+
  theme_bw(); daily_tank

# Save plot 
ggsave("../Output/Daily_Measurements.pdf", daily_tank, width = 20, height = 15, units = c("in"))
```

It isn't super informative to look at multiple years in one plot. 

Filter and plot by the past month
```{r}
# Filter to the past 30 days 
daily_month <- daily.long %>%
  filter(Date >= Sys.Date() - 30)  # Adjust 30 to the number of days you want to consider

# Plot data from the past month
daily_month<-daily_month %>%
  ggplot(aes(x=Date, y=value, colour=Tank_ID))+
  geom_point(size=2)+
  xlab("Date")+
  facet_grid(metric ~ ., scales = "free")+
  theme_bw(); daily_month

# Save plot 
ggsave("../Output/Daily_Measurements_Past_Month.pdf", daily_month, width = 20, height = 15, units = c("in"))
```

Summarize daily measurements over the past month (this will use the `daily` df from above instead of the the `daily.long` df)
```{r}
daily_month <- daily %>% 
  filter(Date >= Sys.Date() - 30)  # Adjust 30 to the number of days you want to consider

summary<-daily_month%>%
  group_by(Tank_ID)%>%
  #select(!tank)%>%
  select(!Date)%>%
  select(!light2:notes)%>%
  summarise(across(everything(), list(mean = mean, sd = sd), na.rm = TRUE)); summary
```
STILL NEED TO MAKE TA PLOTS AND NEED TO GET PH CODE TO WORK